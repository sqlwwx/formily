{"version":3,"file":"index.js","sourceRoot":"","sources":["../../src/form-drawer/index.tsx"],"names":[],"mappings":"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","sourcesContent":["import React, { Fragment, useLayoutEffect, useRef, useState } from 'react'\nimport { createPortal } from 'react-dom'\nimport {\n  createForm,\n  IFormProps,\n  Form,\n  onFormSubmitSuccess,\n} from '@formily/core'\nimport { toJS } from '@formily/reactive'\nimport { FormProvider, observer } from '@formily/react'\nimport {\n  isNum,\n  isStr,\n  isBool,\n  isFn,\n  applyMiddleware,\n  IMiddleware,\n} from '@formily/shared'\nimport { Drawer, DrawerProps } from 'antd'\nimport {\n  usePrefixCls,\n  createPortalProvider,\n  createPortalRoot,\n  loading,\n} from '../__builtins__'\n\ntype FormDrawerRenderer =\n  | React.ReactElement\n  | ((form: Form) => React.ReactElement)\n\ntype DrawerTitle = string | number | React.ReactElement\n\ntype EventType =\n  | React.KeyboardEvent<HTMLDivElement>\n  | React.MouseEvent<HTMLDivElement | HTMLButtonElement>\n\nconst isDrawerTitle = (props: any): props is DrawerTitle => {\n  return (\n    isNum(props) || isStr(props) || isBool(props) || React.isValidElement(props)\n  )\n}\n\nconst getDrawerProps = (props: any): IDrawerProps => {\n  if (isDrawerTitle(props)) {\n    return {\n      title: props,\n    }\n  } else {\n    return props\n  }\n}\n\nexport interface IFormDrawer {\n  forOpen(middleware: IMiddleware<IFormProps>): IFormDrawer\n  open(props?: IFormProps): Promise<any>\n  close(): void\n}\n\nexport interface IDrawerProps extends DrawerProps {\n  onClose?: (e: EventType) => void | boolean\n  loadingText?: React.ReactNode\n}\n\nexport function FormDrawer(\n  title: IDrawerProps,\n  id: string,\n  renderer: FormDrawerRenderer\n): IFormDrawer\nexport function FormDrawer(\n  title: IDrawerProps,\n  id: FormDrawerRenderer\n): IFormDrawer\nexport function FormDrawer(\n  title: DrawerTitle,\n  id: string,\n  renderer: FormDrawerRenderer\n): IFormDrawer\nexport function FormDrawer(\n  title: DrawerTitle,\n  id: FormDrawerRenderer\n): IFormDrawer\nexport function FormDrawer(title: any, id: any, renderer?: any): IFormDrawer {\n  if (isFn(id) || React.isValidElement(id)) {\n    renderer = id\n    id = 'form-drawer'\n  }\n  const env = {\n    host: document.createElement('div'),\n    openMiddlewares: [],\n    form: null,\n    promise: null,\n  }\n  const root = createPortalRoot(env.host, id)\n  const props = getDrawerProps(title)\n  const drawer = {\n    width: '40%',\n    ...props,\n    onClose: (e: any) => {\n      if (props?.onClose?.(e) !== false) {\n        formDrawer.close()\n      }\n    },\n    afterVisibleChange: (visible: boolean) => {\n      props?.afterVisibleChange?.(visible)\n      if (visible) return\n      root.unmount()\n    },\n  }\n  const DrawerContent = observer(() => {\n    return <Fragment>{isFn(renderer) ? renderer(env.form) : renderer}</Fragment>\n  })\n  const renderDrawer = (visible = true) => {\n    return (\n      <Drawer {...drawer} visible={visible}>\n        <FormProvider form={env.form}>\n          <DrawerContent />\n        </FormProvider>\n      </Drawer>\n    )\n  }\n\n  document.body.appendChild(env.host)\n  const formDrawer = {\n    forOpen: (middleware: IMiddleware<IFormProps>) => {\n      if (isFn(middleware)) {\n        env.openMiddlewares.push(middleware)\n      }\n      return formDrawer\n    },\n    open: (props: IFormProps) => {\n      if (env.promise) return env.promise\n      env.promise = new Promise(async (resolve, reject) => {\n        try {\n          props = await loading(drawer.loadingText, () =>\n            applyMiddleware(props, env.openMiddlewares)\n          )\n          env.form =\n            env.form ||\n            createForm({\n              ...props,\n              effects(form) {\n                onFormSubmitSuccess(() => {\n                  resolve(toJS(form.values))\n                  formDrawer.close()\n                })\n                props?.effects?.(form)\n              },\n            })\n        } catch (e) {\n          reject(e)\n        }\n        root.render(() => renderDrawer(false))\n        setTimeout(() => {\n          root.render(() => renderDrawer(true))\n        }, 16)\n      })\n      return env.promise\n    },\n    close: () => {\n      if (!env.host) return\n      root.render(() => renderDrawer(false))\n    },\n  }\n  return formDrawer\n}\n\nconst DrawerFooter: React.FC = (props) => {\n  const ref = useRef<HTMLDivElement>()\n  const [footer, setFooter] = useState<HTMLDivElement>()\n  const footerRef = useRef<HTMLDivElement>()\n  const prefixCls = usePrefixCls('drawer')\n  useLayoutEffect(() => {\n    const content = ref.current?.closest(`.${prefixCls}-wrapper-body`)\n    if (content) {\n      if (!footerRef.current) {\n        footerRef.current = content.querySelector(`.${prefixCls}-footer`)\n        if (!footerRef.current) {\n          footerRef.current = document.createElement('div')\n          footerRef.current.classList.add(`${prefixCls}-footer`)\n          content.appendChild(footerRef.current)\n        }\n      }\n      setFooter(footerRef.current)\n    }\n  })\n\n  footerRef.current = footer\n\n  return (\n    <div ref={ref} style={{ display: 'none' }}>\n      {footer && createPortal(props.children, footer)}\n    </div>\n  )\n}\n\nFormDrawer.Footer = DrawerFooter\n\nFormDrawer.Portal = createPortalProvider('form-drawer')\n\nexport default FormDrawer\n"]}
{"version":3,"file":"formily.reactive-react.umd.development.js","sources":["../../../node_modules/hoist-non-react-statics/dist/hoist-non-react-statics.cjs.js","../src/shared/global.ts","../src/shared/gc.ts","../src/shared/immediate.ts","../src/hooks/useDidUpdate.ts","../src/hooks/useForceUpdate.ts","../src/hooks/useObserver.ts","../src/observer.ts"],"sourcesContent":["'use strict';\n\nvar reactIs = require('react-is');\n\n/**\n * Copyright 2015, Yahoo! Inc.\n * Copyrights licensed under the New BSD License. See the accompanying LICENSE file for terms.\n */\nvar REACT_STATICS = {\n  childContextTypes: true,\n  contextType: true,\n  contextTypes: true,\n  defaultProps: true,\n  displayName: true,\n  getDefaultProps: true,\n  getDerivedStateFromError: true,\n  getDerivedStateFromProps: true,\n  mixins: true,\n  propTypes: true,\n  type: true\n};\nvar KNOWN_STATICS = {\n  name: true,\n  length: true,\n  prototype: true,\n  caller: true,\n  callee: true,\n  arguments: true,\n  arity: true\n};\nvar FORWARD_REF_STATICS = {\n  '$$typeof': true,\n  render: true,\n  defaultProps: true,\n  displayName: true,\n  propTypes: true\n};\nvar MEMO_STATICS = {\n  '$$typeof': true,\n  compare: true,\n  defaultProps: true,\n  displayName: true,\n  propTypes: true,\n  type: true\n};\nvar TYPE_STATICS = {};\nTYPE_STATICS[reactIs.ForwardRef] = FORWARD_REF_STATICS;\nTYPE_STATICS[reactIs.Memo] = MEMO_STATICS;\n\nfunction getStatics(component) {\n  // React v16.11 and below\n  if (reactIs.isMemo(component)) {\n    return MEMO_STATICS;\n  } // React v16.12 and above\n\n\n  return TYPE_STATICS[component['$$typeof']] || REACT_STATICS;\n}\n\nvar defineProperty = Object.defineProperty;\nvar getOwnPropertyNames = Object.getOwnPropertyNames;\nvar getOwnPropertySymbols = Object.getOwnPropertySymbols;\nvar getOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;\nvar getPrototypeOf = Object.getPrototypeOf;\nvar objectPrototype = Object.prototype;\nfunction hoistNonReactStatics(targetComponent, sourceComponent, blacklist) {\n  if (typeof sourceComponent !== 'string') {\n    // don't hoist over string (html) components\n    if (objectPrototype) {\n      var inheritedComponent = getPrototypeOf(sourceComponent);\n\n      if (inheritedComponent && inheritedComponent !== objectPrototype) {\n        hoistNonReactStatics(targetComponent, inheritedComponent, blacklist);\n      }\n    }\n\n    var keys = getOwnPropertyNames(sourceComponent);\n\n    if (getOwnPropertySymbols) {\n      keys = keys.concat(getOwnPropertySymbols(sourceComponent));\n    }\n\n    var targetStatics = getStatics(targetComponent);\n    var sourceStatics = getStatics(sourceComponent);\n\n    for (var i = 0; i < keys.length; ++i) {\n      var key = keys[i];\n\n      if (!KNOWN_STATICS[key] && !(blacklist && blacklist[key]) && !(sourceStatics && sourceStatics[key]) && !(targetStatics && targetStatics[key])) {\n        var descriptor = getOwnPropertyDescriptor(sourceComponent, key);\n\n        try {\n          // Avoid failures from read-only properties\n          defineProperty(targetComponent, key, descriptor);\n        } catch (e) {}\n      }\n    }\n  }\n\n  return targetComponent;\n}\n\nmodule.exports = hoistNonReactStatics;\n","/* istanbul ignore next */\nfunction globalSelf() {\n  try {\n    if (typeof self !== 'undefined') {\n      return self\n    }\n  } catch (e) {}\n  try {\n    if (typeof window !== 'undefined') {\n      return window\n    }\n  } catch (e) {}\n  try {\n    if (typeof global !== 'undefined') {\n      return global\n    }\n  } catch (e) {}\n  return Function('return this')()\n}\n\nexport const globalThisPolyfill: Window = globalSelf()\n","import { globalThisPolyfill } from './global'\n\nconst registry: FinalizationRegistry<any> =\n  globalThisPolyfill['FinalizationRegistry'] &&\n  new globalThisPolyfill['FinalizationRegistry']((token: any) =>\n    token?.clean?.()\n  )\n\ntype Token = { clean: () => void }\nexport class GarbageCollector<T extends object = any> {\n  private expireTime: number\n  private request?: ReturnType<typeof setTimeout>;\n  private token: Token\n  constructor(clean?: () => void, expireTime = 10_000) {\n    this.token = {\n      clean,\n    }\n    this.expireTime = expireTime\n  }\n\n  open(target: T) {\n    if (registry) {\n      registry.register(target, this.token, this.token)\n    } else {\n      this.request = setTimeout(() => {\n        this.token?.clean?.()\n      }, this.expireTime)\n    }\n  }\n\n  close() {\n    if (registry) {\n      registry.unregister(this.token)\n    } else {\n      clearTimeout(this.request)\n    }\n  }\n}\n","export const immediate = (callback?: () => void) => {\n  let disposed = false\n  Promise.resolve(0).then(() => {\n    if (disposed) {\n      disposed = false\n      return\n    }\n    callback()\n  })\n  return () => {\n    disposed = true\n  }\n}\n","import { useLayoutEffect, useRef } from 'react'\nimport { immediate } from '../shared'\n\nexport const useDidUpdate = (callback?: () => void) => {\n  const request = useRef(null)\n  request.current = immediate(callback)\n  useLayoutEffect(() => {\n    request.current()\n    callback()\n  })\n}\n","import { useCallback, useEffect, useRef, useState } from 'react'\nimport { useDidUpdate } from './useDidUpdate'\n\nconst EMPTY_ARRAY: any[] = []\nconst RENDER_COUNT = { value: 0 }\nconst RENDER_QUEUE = new Set<() => void>()\n\nexport function useForceUpdate() {\n  const [, setState] = useState([])\n  const unMountRef = useRef(false)\n\n  useEffect(() => {\n    unMountRef.current = false\n    return () => {\n      unMountRef.current = true\n    }\n  }, EMPTY_ARRAY)\n\n  const update = useCallback(() => {\n    if (unMountRef.current) return\n    setState([])\n  }, EMPTY_ARRAY)\n\n  const scheduler = useCallback(() => {\n    if (RENDER_COUNT.value === 0) {\n      update()\n    } else {\n      RENDER_QUEUE.add(update)\n    }\n  }, EMPTY_ARRAY)\n\n  RENDER_COUNT.value++\n\n  useDidUpdate(() => {\n    if (RENDER_COUNT.value > 0) {\n      RENDER_COUNT.value--\n    }\n    if (RENDER_COUNT.value === 0) {\n      RENDER_QUEUE.forEach((update) => {\n        RENDER_QUEUE.delete(update)\n        update()\n      })\n    }\n  })\n\n  return scheduler\n}\n","import React from 'react'\nimport { Tracker } from '@formily/reactive'\nimport { GarbageCollector } from '../shared'\nimport { IObserverOptions } from '../types'\nimport { useForceUpdate } from './useForceUpdate'\n\nclass ObjectToBeRetainedByReact {}\n\nfunction objectToBeRetainedByReactFactory() {\n  return new ObjectToBeRetainedByReact()\n}\n\nexport const useObserver = <T extends () => any>(\n  view: T,\n  options?: IObserverOptions\n): ReturnType<T> => {\n  const forceUpdate = useForceUpdate()\n  const unMountRef = React.useRef(false)\n  const trackerRef = React.useRef<Tracker>(null)\n  const gcRef = React.useRef<GarbageCollector>()\n  const [objectRetainedByReact] = React.useState(\n    objectToBeRetainedByReactFactory\n  )\n  if (!trackerRef.current) {\n    trackerRef.current = new Tracker(() => {\n      if (typeof options?.scheduler === 'function') {\n        options.scheduler(forceUpdate)\n      } else {\n        forceUpdate()\n      }\n    }, options?.displayName)\n  }\n\n  //StrictMode/ConcurrentMode会导致组件无法正确触发UnMount，所以只能自己做垃圾回收\n  if (!gcRef.current) {\n    gcRef.current = new GarbageCollector(() => {\n      if (trackerRef.current) {\n        trackerRef.current.dispose()\n      }\n    })\n    gcRef.current.open(objectRetainedByReact)\n  }\n\n  React.useEffect(() => {\n    unMountRef.current = false\n    gcRef.current.close()\n    return () => {\n      unMountRef.current = true\n      if (trackerRef.current) {\n        trackerRef.current.dispose()\n        trackerRef.current = null\n      }\n    }\n  }, [])\n\n  return trackerRef.current.track(view)\n}\n","import React, { forwardRef, memo, Fragment } from 'react'\nimport hoistNonReactStatics from 'hoist-non-react-statics'\nimport { useObserver } from './hooks'\nimport { IObserverOptions, IObserverProps } from './types'\n\nexport function observer<\n  P,\n  Options extends IObserverOptions = IObserverOptions\n>(\n  component: React.FunctionComponent<P>,\n  options?: Options\n): React.MemoExoticComponent<\n  React.FunctionComponent<\n    Options extends { forwardRef: true }\n      ? P & {\n          ref?: 'ref' extends keyof P ? P['ref'] : React.RefAttributes<any>\n        }\n      : React.PropsWithoutRef<P>\n  >\n> {\n  const realOptions = {\n    forwardRef: false,\n    ...options,\n  }\n\n  const wrappedComponent = realOptions.forwardRef\n    ? forwardRef((props: any, ref: any) => {\n        return useObserver(() => component({ ...props, ref }), realOptions)\n      })\n    : (props: any) => {\n        return useObserver(() => component(props), realOptions)\n      }\n\n  const memoComponent = memo(wrappedComponent)\n\n  hoistNonReactStatics(memoComponent, component)\n\n  if (realOptions.displayName) {\n    memoComponent.displayName = realOptions.displayName\n  }\n\n  return memoComponent\n}\n\nexport const Observer = observer((props: IObserverProps) => {\n  const children =\n    typeof props.children === 'function' ? props.children() : props.children\n  return React.createElement(Fragment, {}, children)\n})\n"],"names":["reactIs"],"mappings":"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"}
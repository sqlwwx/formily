{"version":3,"file":"observerInVue2.js","sourceRoot":"","sources":["../../src/observer/observerInVue2.ts"],"names":[],"mappings":"AAAA,iEAAiE;;;;;;;;;;;;AAEjE;;;;GAIG;AACH,OAAO,EAAE,OAAO,EAAE,MAAM,mBAAmB,CAAA;AAC3C,OAAO,iBAAiB,MAAM,eAAe,CAAA;AAC7C,OAAO,EAAE,IAAI,IAAI,GAAG,EAAE,MAAM,UAAU,CAAA;AAGtC,IAAM,IAAI,GAAG,cAAO,CAAC,CAAA;AACrB,IAAM,cAAc,GAAG,MAAM,CAAC,gBAAgB,CAAC,CAAA;AAE/C,SAAS,QAAQ,CAAC,SAAc,EAAE,eAAkC;IAClE,IAAM,IAAI,GACR,CAAA,eAAe,aAAf,eAAe,uBAAf,eAAe,CAAE,IAAI;QACpB,SAAiB,CAAC,IAAI;QACtB,SAAiB,CAAC,aAAa;QAChC,CAAC,SAAS,CAAC,WAAW,IAAI,SAAS,CAAC,WAAW,CAAC,IAAI,CAAC;QACrD,aAAa,CAAA;IAEf,IAAM,eAAe,GACnB,OAAO,SAAS,KAAK,QAAQ,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAE,SAAiB,CAAC,OAAO,CAAA;IACxE,+EAA+E;IAC/E,IAAM,cAAc,GAAG,eAAe,CAAC,IAAI,CAAA;IAC3C,IAAM,OAAO,uBACX,IAAI,MAAA,IACD,eAAe,KAClB,IAAI,EAAJ,UAAK,EAAO;YACV,OAAO,iBAAiB,CAAC,EAAE,IAAI,IAAI,EAAE,cAAc,CAAC,CAAA;QACtD,CAAC;QACD,2DAA2D;QAC3D,oHAAoH;QACpH,KAAK,EAAE,EAAE,GACV,CAAA;IAED,oJAAoJ;IACpJ,IAAM,UAAU,GACd,OAAO,SAAS,KAAK,UAAU;QAC/B,MAAM,CAAC,cAAc,CAAC,SAAS,CAAC,SAAS,CAAC,CAAA;IAC5C,IAAM,KAAK,GACT,UAAU,YAAa,GAAW,CAAC,CAAC,CAAC,UAAU,CAAC,WAAW,CAAC,CAAC,CAAC,GAAG,CAAA;IACnE,IAAM,iBAAiB,GAAG,KAAK,CAAC,MAAM,CAAC,OAAO,CAAC,CAAA;IAEzC,IAAA,KAAuB,iBAAiB,CAAC,SAAS,EAAhD,MAAM,YAAA,EAAE,QAAQ,cAAgC,CAAA;IAExD,iBAAiB,CAAC,SAAS,CAAC,MAAM,GAAG;QAAA,iBA4BpC;QA5ByD,cAAc;aAAd,UAAc,EAAd,qBAAc,EAAd,IAAc;YAAd,yBAAc;;QACtE,IAAI,OAAO,GAAG,KAAK,CAAA;QACnB,IAAI,CAAC,cAAc,CAAC,GAAG,IAAI,CAAA;QAE3B,IAAI,iBAAsB,CAAA;QAE1B,IAAM,cAAc,GAAG;YACrB,OAAO,CAAC,KAAK,CAAC;gBACZ,IAAI,CAAC,OAAO,EAAE;oBACZ,MAAM,CAAC,KAAK,CAAC,KAAI,EAAE,IAAI,CAAC,CAAA;oBACxB,OAAO,GAAG,IAAI,CAAA;oBACd,iBAAiB,GAAG,KAAI,CAAC,QAAQ,CAAC,MAAM,CAAA;oBACxC,2EAA2E;oBAC3E,4GAA4G;oBAC5G,KAAI,CAAC,QAAQ,CAAC,MAAM,GAAG,cAAc,CAAA;iBACtC;qBAAM;oBACL,iBAAiB,CAAC,IAAI,CAAC,KAAI,EAAE,KAAI,CAAC,CAAA;iBACnC;YACH,CAAC,CAAC,CAAA;YAEF,OAAO,KAAI,CAAA;QACb,CAAC,CAAA;QAED,IAAM,OAAO,GAAG,IAAI,OAAO,CAAC,cAAc,CAAC,CAAA;QAE3C,IAAI,CAAC,cAAc,CAAC,GAAG,OAAO,CAAC,OAAO,CAAA;QAEtC,OAAO,cAAc,EAAE,CAAA;IACzB,CAAC,CAAA;IAED,iBAAiB,CAAC,SAAS,CAAC,QAAQ,GAAG;QACrC,CAAC;QAAC,IAAY,CAAC,cAAc,CAAC,EAAE,CAAA;QAChC,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,CAAA;IACtB,CAAC,CAAA;IAED,IAAM,uCAAuC,GAC3C,MAAM,CAAC,wBAAwB,CAAC,iBAAiB,EAAE,MAAM,CAAC,IAAI,EAAE,CAAA;IAClE,IAAI,uCAAuC,CAAC,YAAY,KAAK,IAAI,EAAE;QACjE,MAAM,CAAC,cAAc,CAAC,iBAAiB,EAAE,MAAM,EAAE;YAC/C,QAAQ,EAAE,KAAK;YACf,KAAK,EAAE,IAAI;YACX,UAAU,EAAE,KAAK;YACjB,YAAY,EAAE,KAAK;SACpB,CAAC,CAAA;KACH;IAED,OAAO,iBAAiB,CAAA;AAC1B,CAAC;AAED,OAAO,EAAE,QAAQ,EAAE,QAAQ,IAAI,QAAQ,EAAE,CAAA","sourcesContent":["// https://github.com/mobxjs/mobx-vue/blob/master/src/observer.ts\n\n/**\n * @author Kuitos\n * @homepage https://github.com/kuitos/\n * @since 2018-05-22 16:39\n */\nimport { Tracker } from '@formily/reactive'\nimport collectDataForVue from './collectData'\nimport { Vue2 as Vue } from 'vue-demi'\nimport { IObserverOptions } from '../types'\n\nconst noop = () => {}\nconst disposerSymbol = Symbol('disposerSymbol')\n\nfunction observer(Component: any, observerOptions?: IObserverOptions): any {\n  const name =\n    observerOptions?.name ||\n    (Component as any).name ||\n    (Component as any)._componentTag ||\n    (Component.constructor && Component.constructor.name) ||\n    '<component>'\n\n  const originalOptions =\n    typeof Component === 'object' ? Component : (Component as any).options\n  // To not mutate the original component options, we need to construct a new one\n  const dataDefinition = originalOptions.data\n  const options = {\n    name,\n    ...originalOptions,\n    data(vm: any) {\n      return collectDataForVue(vm || this, dataDefinition)\n    },\n    // overrider the cached constructor to avoid extending skip\n    // @see https://github.com/vuejs/vue/blob/6cc070063bd211229dff5108c99f7d11b6778550/src/core/global-api/extend.js#L24\n    _Ctor: {},\n  }\n\n  // we couldn't use the Component as super class when Component was a VueClass, that will invoke the lifecycle twice after we called Component.extend\n  const superProto =\n    typeof Component === 'function' &&\n    Object.getPrototypeOf(Component.prototype)\n  const Super =\n    superProto instanceof (Vue as any) ? superProto.constructor : Vue\n  const ExtendedComponent = Super.extend(options)\n\n  const { $mount, $destroy } = ExtendedComponent.prototype\n\n  ExtendedComponent.prototype.$mount = function (this: any, ...args: any[]) {\n    let mounted = false\n    this[disposerSymbol] = noop\n\n    let nativeRenderOfVue: any\n\n    const reactiveRender = () => {\n      tracker.track(() => {\n        if (!mounted) {\n          $mount.apply(this, args)\n          mounted = true\n          nativeRenderOfVue = this._watcher.getter\n          // rewrite the native render method of vue with our reactive tracker render\n          // thus if component updated by vue watcher, we could re track and collect dependencies by @formily/reactive\n          this._watcher.getter = reactiveRender\n        } else {\n          nativeRenderOfVue.call(this, this)\n        }\n      })\n\n      return this\n    }\n\n    const tracker = new Tracker(reactiveRender)\n\n    this[disposerSymbol] = tracker.dispose\n\n    return reactiveRender()\n  }\n\n  ExtendedComponent.prototype.$destroy = function (this: any) {\n    ;(this as any)[disposerSymbol]()\n    $destroy.apply(this)\n  }\n\n  const extendedComponentNamePropertyDescriptor =\n    Object.getOwnPropertyDescriptor(ExtendedComponent, 'name') || {}\n  if (extendedComponentNamePropertyDescriptor.configurable === true) {\n    Object.defineProperty(ExtendedComponent, 'name', {\n      writable: false,\n      value: name,\n      enumerable: false,\n      configurable: false,\n    })\n  }\n\n  return ExtendedComponent\n}\n\nexport { observer, observer as Observer }\n"]}
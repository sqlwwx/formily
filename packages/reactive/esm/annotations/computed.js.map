{"version":3,"file":"computed.js","sourceRoot":"","sources":["../../src/annotations/computed.ts"],"names":[],"mappings":"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","sourcesContent":["import { ProxyRaw, RawProxy, ReactionStack } from '../environment'\nimport { createAnnotation } from '../internals'\nimport { buildDataTree } from '../tree'\nimport {\n  bindTargetKeyWithCurrentReaction,\n  runReactionsFromTargetKey,\n  bindComputedReactions,\n  hasRunningReaction,\n  isUntracking,\n  batchStart,\n  batchEnd,\n  releaseBindingReactions,\n} from '../reaction'\n\ninterface IValue<T = any> {\n  value?: T\n}\nexport interface IComputed {\n  <T>(compute: () => T): IValue<T>\n  <T>(compute: { get?: () => T; set?: (value: T) => void }): IValue<T>\n}\n\nexport const computed: IComputed = createAnnotation(\n  ({ target, key, value }) => {\n    const store: IValue = {}\n\n    const proxy = {}\n\n    const context = target ? target : store\n    const property = target ? key : 'value'\n    const getter = getGetter(context)\n    const setter = getSetter(context)\n\n    function getGetter(target: any) {\n      if (!target) {\n        if (value && value.get) return value.get\n        return value\n      }\n      const descriptor = Object.getOwnPropertyDescriptor(target, property)\n      if (descriptor && descriptor.get) return descriptor.get\n      return getGetter(Object.getPrototypeOf(target))\n    }\n\n    function getSetter(target: any) {\n      if (!target) {\n        if (value && value.set) return value.set\n        return\n      }\n      const descriptor = Object.getOwnPropertyDescriptor(target, property)\n      if (descriptor && descriptor.set) return descriptor.set\n      return getSetter(Object.getPrototypeOf(target))\n    }\n\n    function compute() {\n      store.value = getter?.call?.(context)\n    }\n    function reaction() {\n      if (ReactionStack.indexOf(reaction) === -1) {\n        releaseBindingReactions(reaction)\n        try {\n          ReactionStack.push(reaction)\n          compute()\n        } finally {\n          ReactionStack.pop()\n        }\n      }\n    }\n    reaction._name = 'ComputedReaction'\n    reaction._scheduler = () => {\n      reaction._dirty = true\n      runReactionsFromTargetKey({\n        target: context,\n        key: property,\n        value: store.value,\n        type: 'set',\n      })\n    }\n    reaction._isComputed = true\n    reaction._dirty = true\n    reaction._context = context\n    reaction._property = property\n\n    ProxyRaw.set(proxy, store)\n    RawProxy.set(store, proxy)\n\n    buildDataTree(target, key, store)\n\n    function get() {\n      if (hasRunningReaction()) {\n        bindComputedReactions(reaction)\n      }\n      if (!isUntracking()) {\n        //如果允许untracked过程中收集依赖，那么永远不会存在绑定，因为_dirty已经设置为false\n        if (reaction._dirty) {\n          reaction()\n          reaction._dirty = false\n        }\n      } else {\n        compute()\n      }\n      bindTargetKeyWithCurrentReaction({\n        target: context,\n        key: property,\n        type: 'get',\n      })\n      return store.value\n    }\n\n    function set(value: any) {\n      try {\n        batchStart()\n        setter?.call?.(context, value)\n      } finally {\n        batchEnd()\n      }\n    }\n    if (target) {\n      Object.defineProperty(target, key, {\n        get,\n        set,\n        enumerable: true,\n        configurable: false,\n      })\n      return target\n    } else {\n      Object.defineProperty(proxy, 'value', {\n        set,\n        get,\n      })\n    }\n    return proxy\n  }\n)\n"]}